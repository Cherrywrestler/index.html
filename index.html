<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhishHunter: Anti-Scam Training</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- NEW: reCAPTCHA Script Loading -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <style>
        :root {
            --color-primary: #10b981; /* Emerald Green */
            --color-secondary: #fcd34d; /* Amber */
            --color-bg-dark: #1f2937;
            --color-card-dark: #374151;
            --color-text-light: #f9fafb;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-dark);
        }

        /* Custom Styles for Clickable/Interactive Zones */
        .scam-indicator {
            /* FIX: Reset cursor and font weight to blend in completely */
            transition: all 0.2s ease-in-out;
            cursor: default; /* Prevents cursor change on hover */
            border-radius: 4px;
            font-weight: 400; /* Ensures it matches the surrounding text */
        }
        .scam-indicator:hover {
            /* FIX: Remove visual hover feedback */
            background-color: transparent; 
            text-decoration: none;
        }
        .scam-indicator.clicked {
            background-color: var(--color-secondary);
            color: var(--color-bg-dark);
            box-shadow: 0 0 10px var(--color-secondary);
            animation: pulse-clicked 0.5s ease-in-out;
            font-weight: 600; /* Make clicked elements stand out */
        }
        .scam-indicator.correct {
            background-color: var(--color-primary);
            color: white;
            font-weight: 600;
        }
        .scam-indicator.revealed {
            background-color: #ef4444; /* Red for revealed scams */
            color: white;
            box-shadow: 0 0 10px #ef4444;
            animation: bounce 0.5s;
            font-weight: 600;
        }

        /* Email Content Styling */
        .email-body {
            white-space: pre-wrap;
            line-height: 1.6;
            min-height: 200px;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #4b5563; /* Slightly lighter gray for paper effect */
            color: #d1d5db;
        }
        .email-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .email-card:hover:not(.selected) {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .email-card.selected {
            border: 3px solid var(--color-primary);
            box-shadow: 0 0 20px var(--color-primary);
            pointer-events: none; /* Disable hover/click when selected */
        }
        .email-card.analysis-mode {
            pointer-events: auto; /* Re-enable for analysis mode */
        }

        /* Animations */
        @keyframes pulse-clicked {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <!-- Header and Scoreboard -->
    <header class="w-full max-w-5xl mb-8 text-center animate-fadeIn">
        <h1 class="text-4xl font-extrabold text-white mb-2 tracking-wider">
            PhishHunter: Anti-Scam Simulator
        </h1>
        <p class="text-gray-400 mb-4">Level: <span id="level-display" class="font-bold text-lg text-emerald-400">1</span> | Total Score: <span id="total-score-display" class="font-bold text-lg text-amber-400">0</span></p>
        <div class="flex justify-center items-center gap-4 text-xs">
            <div id="auth-status" class="text-gray-500">Initializing...</div>
            <button id="signout-button" class="hidden text-red-400 hover:text-red-500 transition font-medium">Sign Out</button>
        </div>
    </header>

    <!-- Main Game Container -->
    <main class="w-full max-w-5xl">
        
        <!-- Loading Indicator -->
        <div id="loading-spinner" class="hidden text-center p-8 bg-gray-700/50 rounded-xl">
            <svg class="animate-spin h-8 w-8 text-emerald-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-white">Generating new scam challenge...</p>
        </div>

        <!-- Instructions/Message Box -->
        <!-- FIX: Removed misleading default text, JS will set it on load -->
        <div id="message-box" class="bg-gray-800 p-4 rounded-xl text-center shadow-lg transition duration-300 mb-6 border border-emerald-500/30">
            <p id="game-message" class="text-white text-lg font-semibold"></p>
        </div>

        <!-- AUTHENTICATION SCREEN -->
        <div id="auth-screen" class="p-8 bg-gray-700 rounded-xl shadow-2xl text-center max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-white mb-6">PhishHunter Login</h2>

            <!-- Magic Link Section (New) -->
            <div id="magic-link-section" class="mb-6 border-b border-gray-600 pb-4">
                <input type="email" id="magic-email" placeholder="Email for Magic Link" class="w-full p-3 mb-3 rounded-lg bg-gray-600 text-white placeholder-gray-400 border border-gray-500 focus:border-cyan-500 focus:ring-cyan-500">
                <button id="magic-link-button" class="w-full px-8 py-3 bg-cyan-500 text-white font-bold rounded-xl shadow-xl hover:bg-cyan-600 transition duration-300 transform hover:scale-105">
                    Login with Magic Link
                </button>
            </div>

            <p class="text-gray-400 mb-4">â€” Or use Email and Password â€”</p>

            <!-- Email/Password Section (Existing) -->
            <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 mb-4 rounded-lg bg-gray-600 text-white placeholder-gray-400 border border-gray-500 focus:border-emerald-500 focus:ring-emerald-500">
            <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 mb-4 rounded-lg bg-gray-600 text-white placeholder-gray-400 border border-gray-500 focus:border-emerald-500 focus:ring-emerald-500">
            
            <!-- NEW: reCAPTCHA Widget -->
            <div id="captcha-container" class="flex justify-center my-4">
                <div class="g-recaptcha" data-sitekey="YOUR_RECAPTCHA_SITE_KEY"></div>
            </div>

            <!-- Penalty Mode Checkbox -->
            <div class="flex items-center justify-center mb-6">
                <input type="checkbox" id="penalty-toggle" checked class="h-4 w-4 text-emerald-600 bg-gray-700 border-gray-600 rounded focus:ring-emerald-500">
                <label for="penalty-toggle" class="ml-2 text-sm text-white font-medium">Enable Penalty Scoring (Recommended)</label>
            </div>

            <button id="login-button" class="w-full px-8 py-3 mb-3 bg-emerald-500 text-white font-bold rounded-xl shadow-xl hover:bg-emerald-600 transition duration-300 transform hover:scale-105">
                Login
            </button>
            <button id="register-button" class="w-full px-8 py-3 mb-6 bg-indigo-500 text-white font-bold rounded-xl shadow-xl hover:bg-indigo-600 transition duration-300 transform hover:scale-105">
                Register New Account
            </button>

            <p id="auth-error" class="text-red-400 text-sm font-medium"></p>
        </div>

        <!-- Initial Start Button (Hidden until logged in) -->
        <div id="start-screen" class="hidden text-center p-8">
            <button id="start-button" class="px-8 py-4 bg-emerald-500 text-white font-bold rounded-xl shadow-xl hover:bg-emerald-600 transition duration-300 transform hover:scale-105">
                Start Level 1
            </button>
        </div>

        <!-- Challenge Area (Hidden until logged in) -->
        <section id="challenge-area" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-4">Challenge: Select the Scam Email</h2>

            <div id="email-selection-stage" class="grid md:grid-cols-2 gap-6 mb-8">
                <!-- Email Card A -->
                <div id="email-A-card" data-id="A" class="email-card p-4 bg-gray-700 rounded-xl shadow-2xl transition duration-300 hover:shadow-emerald-900/50 hover:border-emerald-500/50">
                    <h3 class="text-xl font-bold text-white mb-2">Email A</h3>
                    <div id="email-A-content" class="text-gray-300"></div>
                </div>

                <!-- Email Card B -->
                <div id="email-B-card" data-id="B" class="email-card p-4 bg-gray-700 rounded-xl shadow-2xl transition duration-300 hover:shadow-emerald-900/50 hover:border-emerald-500/50">
                    <h3 class="text-xl font-bold text-white mb-2">Email B</h3>
                    <div id="email-B-content" class="text-gray-300"></div>
                </div>
            </div>

            <!-- Analysis Stage -->
            <div id="analysis-stage" class="hidden p-6 bg-gray-800 rounded-xl shadow-inner border border-amber-500/30">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-amber-400">ANALYSIS MODE: Find the Red Flags!</h2>
                    <button id="hint-button" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105 disabled:opacity-50">
                        âœ¨ Get AI Hint (Cost: 20 pts)
                    </button>
                </div>
                
                <p class="text-gray-400 mb-4">Click on the suspicious words, phrases, sender names, or links within the email body to identify the scam indicators. Minimum required score: <span id="min-score" class="font-bold text-lg text-red-400"></span></p>
                
                <!-- Hint Display Area -->
                <div id="hint-display" class="hidden p-3 mb-4 bg-indigo-900/50 border border-indigo-500/50 rounded-lg text-sm text-indigo-300 transition duration-500 ease-in-out"></div>

                <div id="scam-email-view" class="p-4 bg-gray-900 rounded-lg shadow-xl mb-6">
                    <!-- Scam Email content will be rendered here with clickable zones -->
                </div>

                <div class="flex justify-between items-center">
                    <button id="submit-analysis-button" class="px-6 py-3 bg-amber-500 text-gray-900 font-bold rounded-xl shadow-lg hover:bg-amber-400 transition duration-300 transform hover:scale-105 disabled:opacity-50" disabled>
                        Submit Analysis
                    </button>
                    <div class="text-2xl font-extrabold text-white">
                        Current Score: <span id="current-score-display" class="text-amber-400">0</span>
                    </div>
                </div>
            </div>

            <!-- Results Stage -->
            <div id="results-stage" class="hidden p-6 bg-gray-800 rounded-xl shadow-inner border border-emerald-500/30">
                <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
                <p class="text-lg text-white mb-4">Your Final Score: <span id="final-score-display" class="font-extrabold text-4xl"></span></p>
                
                <h3 class="text-xl font-semibold text-emerald-400 mt-6 mb-2">AI Expert Breakdown:</h3>
                <div id="breakdown-details" class="text-gray-300 email-body !bg-gray-700/50">
                    <!-- Detailed explanation from the AI will go here -->
                </div>

                <!-- Post-Game Reflection Chat Feature -->
                <h3 class="text-xl font-semibold text-purple-400 mt-8 mb-4">âœ¨ Ask the AI Expert:</h3>
                <div id="reflection-chat" class="p-4 bg-gray-700 rounded-lg">
                    <div id="chat-output" class="mb-4 h-32 overflow-y-auto text-sm">
                        <p class="text-gray-400">The expert is ready. Ask a question about the specific scam you just analyzed (e.g., "What is spear phishing?" or "How could the scammer have made the email more convincing?").</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Ask your follow-up question..." class="flex-grow p-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:border-purple-500 focus:ring-purple-500">
                        <button id="chat-submit-button" class="px-4 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition disabled:opacity-50">Ask</button>
                    </div>
                </div>

                <button id="next-level-button" class="mt-8 px-8 py-4 bg-emerald-500 text-white font-bold rounded-xl shadow-xl hover:bg-emerald-600 transition duration-300 transform hover:scale-105">
                    Continue to Next Level
                </button>
            </div>

        </section>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Constants and State ---
        let db;
        let auth;
        let userId = 'anon';
        let currentLevel = 1;
        let totalScore = 0;
        let challengeData = null; // Stores the AI challenge object
        let currentScore = 0;
        let hintUsed = false;
        let isPenaltyEnabled = true; // Penalty toggle state
        
        const HINT_COST = 20; // Points deducted for using a hint
        const MIN_SCORE_REQUIRED = 150; // Points needed to pass a level
        const SCORE_PER_FLAG = 50;
        const PENALTY_PER_MISTAKE = 10;
        
        // --- UI Elements (Declaration only, initialization moved to setupFirebase) ---
        let ui = {};

        // --- Gemini API Key (SET TO EMPTY STRING FOR SECURITY) ---
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const apiKey = ""; 

        // Define the JSON schema for the AI response (UNCHANGED)
        const RESPONSE_SCHEMA = {
            type: "OBJECT",
            properties: {
                legit_email: {
                    type: "OBJECT",
                    properties: {
                        subject: { type: "STRING" },
                        sender: { type: "STRING" },
                        body: { type: "STRING" }
                    },
                    required: ["subject", "sender", "body"]
                },
                scam_email: {
                    type: "OBJECT",
                    properties: {
                        subject: { type: "STRING" },
                        sender: { type: "STRING" },
                        body: { type: "STRING" },
                        // Indicators array defines the scam markers and their explanations
                        indicators: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    id: { type: "NUMBER" },
                                    flag: { type: "STRING", description: "The type of red flag, e.g., 'Suspicious Domain', 'Urgency', 'Spelling Error'." },
                                    segment: { type: "STRING", description: "The exact text segment in the body or sender that contains the scam." },
                                    explanation: { type: "STRING", description: "A detailed explanation of why this segment is a scam indicator." }
                                },
                                required: ["id", "flag", "segment", "explanation"]
                            }
                        }
                    },
                    required: ["subject", "sender", "body", "indicators"]
                },
                breakdown: { type: "STRING", description: "A comprehensive summary explaining why the scam email is dangerous, formatted as a detailed, polite expert response." }
            },
            required: ["legit_email", "scam_email", "breakdown"]
        };

        // --- Helper function to check CAPTCHA response ---
        function checkCaptcha() {
            // Check if the global grecaptcha object is available
            if (typeof grecaptcha === 'undefined' || typeof grecaptcha.getResponse === 'undefined') {
                // If CAPTCHA script hasn't loaded (or failed), we skip the check for functionality,
                // but log an error since it's a security feature.
                console.warn("CAPTCHA object not found. Skipping CAPTCHA check.");
                return true;
            }
            
            const response = grecaptcha.getResponse();
            if (!response) {
                ui.authError.textContent = "Please complete the 'I'm not a robot' check.";
                return false;
            }
            // In a real app, you MUST send 'response' to a secure backend server 
            // for verification against your Secret Key.
            // For this client-side demo, we only check for completion.
            return true;
        }


        // --- Firebase Authentication Handlers ---
        function handleAuthError(error) {
            ui.authError.textContent = error.message.replace('Firebase: ', '').replace(/\s\(auth\/.+\)\./, '');
            // Optionally reset CAPTCHA on error
            if (typeof grecaptcha !== 'undefined') {
                grecaptcha.reset(); 
            }
        }

        async function handleRegister() {
            if (!checkCaptcha()) return;

            const email = ui.authEmail.value;
            const password = ui.authPassword.value;
            ui.authError.textContent = '';
            
            if (!email || !password) {
                ui.authError.textContent = "Please enter both email and password.";
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // Auth listener handles the rest
            } catch (error) {
                handleAuthError(error);
            }
        }

        async function handleLogin() {
            if (!checkCaptcha()) return;

            const email = ui.authEmail.value;
            const password = ui.authPassword.value;
            ui.authError.textContent = '';

            if (!email || !password) {
                ui.authError.textContent = "Please enter both email and password.";
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth listener handles the rest
            } catch (error) {
                handleAuthError(error);
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out failed:", error);
            }
        }

        // --- Magic Link Handlers ---
        const actionCodeSettings = {
            // URL you want to allow a user to go back to.
            // MUST be the exact URL the app is running on (e.g., http://localhost:8000/)
            url: window.location.href.split('?')[0],
            handleCodeInApp: true,
        };
        
        async function handleSendMagicLink() {
            if (!checkCaptcha()) return;
            
            const email = ui.magicEmail.value.trim();
            ui.authError.textContent = '';

            if (!email) {
                ui.authError.textContent = "Please enter your email for the magic link.";
                return;
            }

            try {
                localStorage.setItem('emailForSignIn', email);
                
                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                
                ui.authError.textContent = `âœ… Magic link sent to ${email}! Check your inbox and click the link to sign in.`;
                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.reset(); // Reset CAPTCHA after successful send
                }
            } catch (error) {
                console.error("Magic link send failed:", error);
                handleAuthError(error);
            }
        }

        async function handleMagicLinkSignIn() {
            if (isSignInWithEmailLink(auth, window.location.href)) {
                let email = localStorage.getItem('emailForSignIn');
                if (!email) {
                    email = prompt("Please confirm your email address to complete the sign-in.");
                }
                
                if (!email) return;

                ui.authError.textContent = "Attempting to sign in with magic link...";

                try {
                    await signInWithEmailLink(auth, email, window.location.href);
                    
                    localStorage.removeItem('emailForSignIn');
                    window.history.replaceState({}, document.title, window.location.href.split('?')[0]);

                } catch (error) {
                    console.error("Magic link sign-in failed:", error);
                    ui.authError.textContent = `Magic link sign-in failed. Please try logging in again.`;
                }
            }
        }
        // --- END Magic Link Handlers ---


        // --- UI State Management ---
        function updateUIForAuthState(user) {
            if (user) {
                ui.authScreen.classList.add('hidden');
                ui.startScreen.classList.remove('hidden');
                ui.signoutButton.classList.remove('hidden');
                ui.authStatus.textContent = `Signed in as: ${user.email || user.uid.substring(0, 8) + '...'}`;
                // LOGGED IN MESSAGE
                ui.gameMessage.textContent = `Welcome, PhishHunter! Click "Start Level" to begin your training.`;
            } else {
                // Not authenticated
                ui.authScreen.classList.remove('hidden');
                ui.startScreen.classList.add('hidden');
                ui.challengeArea.classList.add('hidden');
                ui.analysisStage.classList.add('hidden');
                ui.resultsStage.classList.add('hidden');
                ui.signoutButton.classList.add('hidden');
                ui.authStatus.textContent = `Please Login or Register.`;
                // LOGGED OUT MESSAGE
                ui.gameMessage.textContent = `Welcome, PhishHunter! Please log in to start your training.`;
                userId = 'anon';
            }
        }

        // --- Firebase Initialization ---
        function setupFirebase() {
            // FIX: Move UI element retrieval here to ensure the DOM is ready before trying to find elements.
            ui = {
                loading: document.getElementById('loading-spinner'),
                messageBox: document.getElementById('message-box'),
                gameMessage: document.getElementById('game-message'),
                startScreen: document.getElementById('start-screen'),
                startButton: document.getElementById('start-button'),
                challengeArea: document.getElementById('challenge-area'),
                selectionStage: document.getElementById('email-selection-stage'),
                analysisStage: document.getElementById('analysis-stage'),
                resultsStage: document.getElementById('results-stage'),
                submitButton: document.getElementById('submit-analysis-button'),
                nextButton: document.getElementById('next-level-button'),
                scoreDisplay: document.getElementById('current-score-display'),
                totalScoreDisplay: document.getElementById('total-score-display'),
                levelDisplay: document.getElementById('level-display'),
                minScore: document.getElementById('min-score'),
                finalScoreDisplay: document.getElementById('final-score-display'),
                resultTitle: document.getElementById('result-title'),
                breakdownDetails: document.getElementById('breakdown-details'),
                authStatus: document.getElementById('auth-status'),
                // New elements for LLM features
                hintButton: document.getElementById('hint-button'),
                hintDisplay: document.getElementById('hint-display'),
                chatOutput: document.getElementById('chat-output'),
                chatInput: document.getElementById('chat-input'),
                chatSubmitButton: document.getElementById('chat-submit-button'),
                // New elements for Login
                authScreen: document.getElementById('auth-screen'),
                authEmail: document.getElementById('auth-email'),
                authPassword: document.getElementById('auth-password'),
                loginButton: document.getElementById('login-button'),
                registerButton: document.getElementById('register-button'),
                authError: document.getElementById('auth-error'),
                signoutButton: document.getElementById('signout-button'),
                // NEW: Penalty Toggle
                penaltyToggle: document.getElementById('penalty-toggle'),
                // NEW: Magic Link Elements
                magicEmail: document.getElementById('magic-email'),
                magicLinkButton: document.getElementById('magic-link-button')
            };

            // Set up event listeners that rely on UI elements *after* they are found
            ui.startButton.onclick = startLevel;
            ui.nextButton.onclick = startLevel;
            ui.submitButton.onclick = handleSubmitAnalysis;
            ui.hintButton.onclick = getAIHint;
            ui.chatSubmitButton.onclick = handleChatSubmit;
            ui.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleChatSubmit();
            });
            // Auth Event Listeners
            ui.loginButton.onclick = handleLogin;
            ui.registerButton.onclick = handleRegister;
            ui.signoutButton.onclick = handleSignOut;
            // NEW: Magic Link Listener
            ui.magicLinkButton.onclick = handleSendMagicLink;
            // Penalty Toggle Listener
            ui.penaltyToggle.addEventListener('change', () => {
                isPenaltyEnabled = ui.penaltyToggle.checked;
                if (!isPenaltyEnabled) {
                    ui.gameMessage.textContent = "Penalty Scoring is DISABLED. Enjoy the training!";
                } else {
                    ui.gameMessage.textContent = "Penalty Scoring is ENABLED. Train seriously!";
                }
            });
            
            try {
                // setLogLevel('Debug');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

                if (!firebaseConfig) {
                    console.error("Firebase config is missing.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // IMPORTANT: Check for and complete Magic Link sign-in immediately
                handleMagicLinkSignIn();

                // Sign in logic
                onAuthStateChanged(auth, async (user) => {
                    updateUIForAuthState(user);

                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth State Changed: Logged in.", userId);
                        // Fetch the user's saved game state
                        await fetchGameState(appId);
                    } else if (initialAuthToken) {
                        // Use custom token for initial sign-in (for canvas environment only)
                        await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                            console.error("Custom Token Sign-In failed, requiring manual login:", e);
                            // Fall through to manual login screen
                        });
                    } else {
                         // Default to manual login screen
                    }
                });

            } catch (error) {
                console.error("Firebase setup error:", error);
                ui.authStatus.textContent = `Error initializing Firebase. Check console.`;
            }
        }
        
        // --- Firestore Game State Management ---
        async function fetchGameState(appId) {
            if (!db || !userId || !auth.currentUser) return; // Must be authenticated
            
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/gameState`, 'phishHunter');
            
            console.log(`[Firestore Access] Attempting to READ from path: ${docRef.path}`); // LOGGING PATH
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentLevel = data.level || 1;
                    totalScore = data.score || 0;
                    // Restore penalty setting from saved state, or use default if not saved
                    if (data.isPenaltyEnabled !== undefined) {
                        isPenaltyEnabled = data.isPenaltyEnabled;
                        ui.penaltyToggle.checked = isPenaltyEnabled;
                    }
                    updateScoreboard();
                    console.log("Game state loaded:", data);
                } else {
                    console.log("No game state found, starting fresh. Attempting to save initial state.");
                    saveGameState(); // Save initial state
                }
            }, (error) => {
                console.error("Error listening to game state:", error);
                // The expected security error means the rules are missing or incorrect.
                if (error.code === 'permission-denied') {
                    console.error("ACTION REQUIRED: Ensure Firestore Rules allow read/write access for your user ID!");
                    console.error("Security Rule Check: You must publish the following rules in your Firebase console:");
                    console.error(`
                        rules_version = '2';
                        service cloud.firestore {
                          match /databases/{database}/documents {
                            match /artifacts/{appId}/users/{userId}/{document=**} {
                              allow read, write: if request.auth != null && request.auth.uid == userId;
                            }
                          }
                        }
                    `);
                }
            });
        }

        async function saveGameState() {
            if (!db || !userId || !auth.currentUser) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/gameState`, 'phishHunter');
            
            console.log(`[Firestore Access] Attempting to WRITE to path: ${docRef.path}`); // LOGGING PATH

            try {
                await setDoc(docRef, {
                    level: currentLevel,
                    score: totalScore,
                    isPenaltyEnabled: isPenaltyEnabled, // NEW: Save penalty setting
                    lastUpdated: new Date()
                }, { merge: true });
                console.log("Game state saved successfully.");
            } catch (e) {
                console.error("Error saving game state: ", e);
            }
        }

        // --- Gemini API Interaction (Core Challenge Generation) ---
        
        async function fetchChallenge(level) {
            ui.loading.classList.remove('hidden');
            ui.challengeArea.classList.add('hidden');
            ui.gameMessage.textContent = `Generating Level ${level} challenge...`;

            const systemPrompt = `You are a sophisticated AI simulation engine for anti-scam training. Your task is to generate one highly realistic, professional-looking legitimate email and one highly realistic, modern phishing/scam email for Level ${level}. The scam email MUST incorporate 3 to 5 clear, modern 'red flags' (scam indicators). For the scam email, you must precisely identify the exact text segments corresponding to each indicator. Return the data as a JSON object strictly following the provided schema. The difficulty should increase with the level, making the scam indicators more subtle.`;
            const userQuery = `Generate a new email challenge. The legitimate email should be a standard utility bill notification or receipt. The scam email should be a highly urgent, fraudulent notice about a compromised password or unauthorized access from a major online service (like a bank or email provider). Ensure the scam email includes at least one malicious-looking URL segment and a generic salutation.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: RESPONSE_SCHEMA
                }
            };
            
            console.log("API Payload:", JSON.stringify(payload, null, 2));

            // API Key removed from URL for security.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

            for (let i = 0; i < 3; i++) { // Exponential backoff retry loop
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error("AI response was empty or malformed.");

                    const data = JSON.parse(jsonText);
                    return data;

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < 2) await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Wait 1s, 2s
                    else throw new Error("Failed to fetch challenge after multiple retries.");
                }
            }
        }

        // --- GEMINI FEATURE 1: AI Hint System ---
        async function getAIHint() {
            if (currentScore < HINT_COST && isPenaltyEnabled) {
                ui.hintDisplay.textContent = `ðŸš¨ Not enough points! You need ${HINT_COST} points to use an AI Hint.`;
                ui.hintDisplay.classList.remove('hidden');
                return;
            }

            // Deduct points only if penalty is enabled
            if (isPenaltyEnabled) {
                currentScore -= HINT_COST;
            }
            updateScoreboard();
            
            ui.hintButton.disabled = true;
            ui.hintDisplay.classList.remove('hidden');
            ui.hintDisplay.innerHTML = 'âœ¨ AI Expert thinking...';
            
            const firstIndicator = challengeData.scam_email.indicators[0];
            const scamSubject = challengeData.scam_email.subject;
            const scamSender = challengeData.scam_email.sender;

            const systemPrompt = `You are a helpful cybersecurity coach. Provide a single, concise hint about the current scam. Do NOT reveal the exact words or phrases that need clicking. Instead, hint at the TYPE of red flag that is present, or the general AREA of the email (subject, sender, or body) where the most critical mistake is located. Keep it encouraging.`;
            const userQuery = `The scam email has the subject "${scamSubject}" and is from "${scamSender}". One critical red flag is of the type: "${firstIndicator.flag}". Give a subtle hint to help the user find a red flag without revealing the exact text.`;

            try {
                 // API Key removed from URL for security.
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                 const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Hint API failed with status ${response.status}`);
                const result = await response.json();
                const hintText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a hint right now. Try looking for unusual urgency!";
                
                ui.hintDisplay.innerHTML = `**AI Hint:** ${hintText} ${!isPenaltyEnabled ? '(No points deducted in No Penalty Mode!)' : ''}`;
                hintUsed = true; // Mark hint as used for this level

            } catch (error) {
                console.error("Hint generation error:", error);
                ui.hintDisplay.innerHTML = `**AI Hint:** Error generating hint. Focus on the sender's address or urgent tone!`;
            } finally {
                ui.hintButton.disabled = false;
            }
        }


        // --- GEMINI FEATURE 2: Post-Game Reflection Chat ---
        async function handleChatSubmit() {
            const query = ui.chatInput.value.trim();
            if (!query) return;

            ui.chatInput.value = '';
            ui.chatSubmitButton.disabled = true;
            
            // Display user message
            ui.chatOutput.innerHTML += `<p class="text-white mt-1"><strong>You:</strong> ${htmlEncode(query)}</p>`;
            ui.chatOutput.scrollTop = ui.chatOutput.scrollHeight;

            // Display loading indicator for AI response
            const loadingHtml = `<p class="text-purple-400 mt-1" id="ai-loading-msg"><strong>AI Expert:</strong> Thinking...</p>`;
            ui.chatOutput.innerHTML += loadingHtml;
            ui.chatOutput.scrollTop = ui.chatOutput.scrollHeight;
            
            const loadingMsg = document.getElementById('ai-loading-msg');
            
            const scamBreakdown = challengeData.breakdown;
            const fullScamContent = JSON.stringify(challengeData.scam_email, null, 2);

            const systemPrompt = `You are a cybersecurity expert providing post-analysis consultation. The user has just completed a training level on a phishing email. Respond to their question based on the context of the scam provided below. Do NOT simply repeat the breakdown. Be informative, concise, and helpful. If the user asks general questions about cybersecurity, use the specific scam context to ground your answer. Context: Breakdown: ${scamBreakdown}\n Full Scam Data: ${fullScamContent}`;
            const userQuery = query;

            try {
                 // API Key removed from URL for security.
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                 const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Chat API failed with status ${response.status}`);
                const result = await response.json();
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || "I apologize, I'm having trouble processing that specific question.";
                
                // Replace loading message with actual response
                if(loadingMsg) loadingMsg.remove();
                ui.chatOutput.innerHTML += `<p class="text-purple-300 mt-1"><strong>AI Expert:</strong> ${aiResponse}</p>`;

            } catch (error) {
                console.error("Chat generation error:", error);
                if(loadingMsg) loadingMsg.remove();
                ui.chatOutput.innerHTML += `<p class="text-red-400 mt-1"><strong>AI Expert:</strong> Sorry, an error occurred while connecting to the expert.</p>`;

            } finally {
                ui.chatSubmitButton.disabled = false;
                ui.chatOutput.scrollTop = ui.chatOutput.scrollHeight;
            }
        }
        
        // --- Game Logic and UI Management ---

        function updateScoreboard() {
            ui.levelDisplay.textContent = currentLevel;
            ui.totalScoreDisplay.textContent = totalScore;
            ui.scoreDisplay.textContent = currentScore;
            ui.minScore.textContent = MIN_SCORE_REQUIRED;
        }

        function resetChallengeUI() {
            ui.selectionStage.classList.remove('hidden');
            ui.analysisStage.classList.add('hidden');
            ui.resultsStage.classList.add('hidden');
            
            // Reset hint status
            hintUsed = false;
            ui.hintDisplay.classList.add('hidden');
            ui.hintButton.disabled = false;

            // Clear chat history
            ui.chatOutput.innerHTML = `<p class="text-gray-400">The expert is ready. Ask a question about the specific scam you just analyzed (e.g., "What is spear phishing?" or "How could the scammer have made the email more convincing?").</p>`;
            
            // Clear only the dynamic content 
            const contentDivA = document.getElementById('email-A-content');
            const contentDivB = document.getElementById('email-B-content');
            
            if (contentDivA) {
                contentDivA.innerHTML = ''; 
            }
            if (contentDivB) {
                contentDivB.innerHTML = ''; 
            }

            // Reset email card classes
            document.querySelectorAll('.email-card').forEach(card => {
                card.classList.remove('selected', 'analysis-mode');
                card.onclick = handleEmailSelection;
            });
            
            ui.submitButton.disabled = true;
            currentScore = 0;
            updateScoreboard();
        }

        function htmlEncode(str) {
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#39;');
        }

        function renderEmails(data) {
            challengeData = data;
            
            // Randomly assign which one is the scam
            const isScamA = Math.random() > 0.5;
            const emailA = isScamA ? data.scam_email : data.legit_email;
            const emailB = isScamA ? data.legit_email : data.scam_email;

            // Store the correct ID for scoring
            challengeData.correctId = isScamA ? 'A' : 'B';

            // Function to build the DYNAMIC INNER CONTENT of the email card
            const buildEmailContentHtml = (email) => `
                <div class="p-2 border-b border-gray-600 mb-2">
                    <p class="text-xs text-gray-400">From: <span class="font-medium">${htmlEncode(email.sender)}</span></p>
                    <p class="text-sm font-semibold text-gray-200">Subject: ${htmlEncode(email.subject)}</p>
                </div>
                <div class="email-body text-sm overflow-hidden h-40">
                    ${email.body.split('\n').map(line => `<p>${htmlEncode(line)}</p>`).join('')}
                </div>
            `;
            
            // Find the specific content DIVs inside the cards
            const contentDivA = document.getElementById('email-A-content');
            const contentDivB = document.getElementById('email-B-content');
            
            // Inject new content
            if (contentDivA) {
                contentDivA.innerHTML = buildEmailContentHtml(emailA);
            } else {
                console.error("Could not find element: email-A-content");
            }
            
            if (contentDivB) {
                contentDivB.innerHTML = buildEmailContentHtml(emailB);
            } else {
                console.error("Could not find element: email-B-content");
            }

            // Update card attributes after content is loaded
            document.getElementById('email-A-card').dataset.type = isScamA ? 'scam' : 'legit';
            document.getElementById('email-B-card').dataset.type = isScamA ? 'legit' : 'scam';


            ui.gameMessage.textContent = `Level ${currentLevel}: Identify the phishing attempt and click on it.`;
            ui.loading.classList.add('hidden');
            ui.challengeArea.classList.remove('hidden');

            
        }

        function renderScamForAnalysis(scamEmail) {
            const container = document.getElementById('scam-email-view');
            
            let renderedBody = htmlEncode(scamEmail.body);
            
            // Map indicators for replacement
            const indicatorsMap = {};
            scamEmail.indicators.forEach(ind => {
                // Use a simple token replacement, making sure to escape special chars for RegExp
                const escapedSegment = ind.segment.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                const uniqueToken = `___SCAM_INDICATOR_${ind.id}___`;
                // Use a non-global regex replacement to ensure only one segment of the same text is replaced once
                renderedBody = renderedBody.replace(new RegExp(escapedSegment, 'g'), uniqueToken);
                indicatorsMap[uniqueToken] = ind;
            });

            // Replace tokens with interactive HTML elements
            for (const token in indicatorsMap) {
                const ind = indicatorsMap[token];
                const cleanSegment = htmlEncode(ind.segment);
                const replacementHtml = `<span class="scam-indicator p-0.5" data-id="${ind.id}" data-flag="${ind.flag}">${cleanSegment}</span>`;
                // Use a specific regex replacement for the unique token
                renderedBody = renderedBody.replace(new RegExp(token, 'g'), replacementHtml);
            }
            
            // Build final HTML
            container.innerHTML = `
                <div class="p-2 border-b border-gray-600 mb-2">
                    <p class="text-xs text-gray-400">From: <span class="font-medium">${htmlEncode(scamEmail.sender)}</span></p>
                    <p class="text-sm font-semibold text-gray-200">Subject: ${htmlEncode(scamEmail.subject)}</p>
                </div>
                <div id="clickable-body" class="email-body text-sm">
                    ${renderedBody.split('\n').map(line => `<p>${line}</p>`).join('')}
                </div>
            `;

            // Attach event listener to the clickable body
            document.getElementById('clickable-body').onclick = handleAnalysisClick;
        }

        // --- Event Handlers ---
        
        function handleEmailSelection(event) {
            const card = event.currentTarget;
            
            // Only proceed if not in analysis mode
            if (ui.selectionStage.classList.contains('hidden')) return;

            // Highlight selection
            document.querySelectorAll('.email-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');

            const selectedId = card.dataset.id;
            const isCorrectSelection = selectedId === challengeData.correctId;
            
            if (isCorrectSelection) {
                currentScore += 100; // Bonus for correct selection
                ui.gameMessage.textContent = `Correct! Now, find the red flags in the scam email below by clicking on them.`;
                
                // Transition to analysis stage
                ui.selectionStage.classList.add('hidden');
                ui.analysisStage.classList.remove('hidden');
                
                // Render the scam email for analysis
                const scamEmail = (selectedId === 'A') ? 
                    (card.dataset.type === 'scam' ? challengeData.scam_email : challengeData.legit_email) :
                    (card.dataset.type === 'scam' ? challengeData.scam_email : challengeData.legit_email);
                
                renderScamForAnalysis(challengeData.scam_email);
                updateScoreboard();

            } else {
                // Apply penalty only if enabled
                if (isPenaltyEnabled) {
                    currentScore -= 50; // Penalty for incorrect selection
                } else {
                    ui.gameMessage.textContent = `Incorrect selection, but no penalty applied. Try again!`;
                }
                updateScoreboard();
                
                // Fail the level immediately on wrong selection
                handleLevelEnd(false); 
            }
        }

        function handleAnalysisClick(event) {
            const element = event.target;
            
            if (element.classList.contains('scam-indicator') && !element.classList.contains('clicked')) {
                // Correct click
                element.classList.add('clicked');
                element.style.pointerEvents = 'none'; // Disable further clicks on this segment
                currentScore += SCORE_PER_FLAG;
                ui.submitButton.disabled = false; // Enable submit button

            } else if (element.tagName === 'P' || element.classList.contains('email-body')) {
                // Clicked on non-scam text (penalty)
                
                // Apply penalty only if enabled
                if (isPenaltyEnabled) {
                    currentScore = Math.max(0, currentScore - PENALTY_PER_MISTAKE); // Score doesn't go below 0
                    ui.gameMessage.textContent = `Penalty! You clicked on a legitimate element. Score: ${currentScore}`;
                } else {
                    ui.gameMessage.textContent = `Non-scam element clicked (No penalty).`;
                }
                
            } else if (element.tagName === 'A') {
                 // Treat links as potentially clickable elements even if not marked as indicators, unless they are already marked.
                 if (!element.querySelector('.scam-indicator') && !element.classList.contains('scam-indicator')) {
                     // Apply penalty only if enabled
                    if (isPenaltyEnabled) {
                        currentScore = Math.max(0, currentScore - PENALTY_PER_MISTAKE);
                        ui.gameMessage.textContent = `Penalty! That link seems fine, but be careful! Score: ${currentScore}`;
                    } else {
                        ui.gameMessage.textContent = `Link clicked (No penalty).`;
                    }
                 }
            }
            
            updateScoreboard();
        }

        async function handleSubmitAnalysis() {
            // Check if user passed
            const passed = currentScore >= MIN_SCORE_REQUIRED;
            
            // Finalize analysis UI: Mark all indicators
            const allIndicators = document.querySelectorAll('.scam-indicator');
            allIndicators.forEach(ind => {
                ind.classList.add('revealed'); // Show all, including missed ones
                ind.style.pointerEvents = 'none'; // Lock all elements
                if (ind.classList.contains('clicked')) {
                    ind.classList.add('correct'); // Highlight successfully clicked ones
                }
            });

            // Disable submit button
            ui.submitButton.disabled = true;
            
            // Delay to let the user see the visual feedback before showing results
            setTimeout(() => {
                handleLevelEnd(passed);
            }, 1000);
        }
        
        function handleLevelEnd(passed) {
            ui.selectionStage.classList.add('hidden');
            ui.analysisStage.classList.add('hidden');
            ui.resultsStage.classList.remove('hidden');
            
            if (passed) {
                totalScore += currentScore;
                currentLevel++;
                ui.resultTitle.textContent = "LEVEL CLEARED! âœ…";
                ui.resultTitle.classList.remove('text-red-500');
                ui.resultTitle.classList.add('text-emerald-500');
                ui.nextButton.textContent = "Continue to Next Level";
            } else {
                // If they fail, they retry the same level, but we still add/subtract the score earned on that attempt.
                totalScore = Math.max(0, totalScore + currentScore); 
                ui.resultTitle.textContent = "LEVEL FAILED! âŒ";
                ui.resultTitle.classList.remove('text-emerald-500');
                ui.resultTitle.classList.add('text-red-500');
                ui.nextButton.textContent = "Try Level Again";
            }
            
            ui.finalScoreDisplay.textContent = currentScore;
            ui.breakdownDetails.innerHTML = challengeData.breakdown;
            
            updateScoreboard();
            saveGameState();
        }

        async function startLevel() {
            if (!auth.currentUser) {
                ui.gameMessage.textContent = "Please log in to start the game.";
                return;
            }
            resetChallengeUI();
            ui.startScreen.classList.add('hidden');

            try {
                const data = await fetchChallenge(currentLevel);
                renderEmails(data);

                // Set up email selection listeners
                document.getElementById('email-A-card').onclick = handleEmailSelection;
                document.getElementById('email-B-card').onclick = handleEmailSelection;
                
            } catch (e) {
                console.error("Game error:", e);
                ui.loading.classList.add('hidden');
                ui.gameMessage.textContent = `Error: Could not load challenge. Please check the console.`;
                ui.startScreen.classList.remove('hidden');
            }
        }

        // --- Application Start ---
        window.onload = setupFirebase;

    </script>
</body>
</html>
